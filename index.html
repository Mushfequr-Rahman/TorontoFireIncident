<!DOCTYPE html>

<head>
    <title> Toronto Fire Incidents</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="/images/icon.png" type="image/x-icon">
</head>

<body>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="https://d3js.org/d3-array.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo.v1.min.js"></script>
    <script src="https://d3js.org/d3-array.v2.min.js"></script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-format.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-time.v1.min.js"></script>
    <script src="https://d3js.org/d3-time-format.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale.v3.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-brush.v1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <!--Newer version of the libraries, still conflicting syntax with the base code-->
    <!--<script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>-->

    <!--   center svg in div   -->
    <div class="wrapper">


        <div id="date_filter" class="inline">
            <input type="text" id="daterange" />
        </div>

        <div id="cause_filter" class="inline">
            Cause of Fire incidents:<br>
            <input type="checkbox" checked name="cause" value="Undetermined"><label>Undetermined</label><br>
            <input type="checkbox" checked name="cause" value="Electrical Failure"><label>Electrical Failure</label><br>
            <input type="checkbox" checked name="cause" value="Improperly Discarded"><label>Improperly
                Discarded</label><br>
            <input type="checkbox" checked name="cause" value="Unattended"><label>Unattended</label><br>
            <input type="checkbox" checked name="cause" value="Other unintentional cause"><label>Other Unintentional
                Cause</label><br>
        </div>
        <!--Potential source: http://bl.ocks.org/timelyportfolio/5c136de85de1c2abb6fc-->

        <!--Gradient Legend-->
        <div id="legends"></div>
        <div id="vis"></div>
    </div>

    <script>
        // load TopoJSON file
        d3.json("data/toronto_topo.json", function(error, toronto) {
            if (error) throw error;
            // Load Toronto Fire Dataset here: 
            d3.json("data/Fire_Incidents_Data.json", function(error, fire) {
                d3.json("data/toronto_fire_stations.json", function(error, station) {

                    // console.log("Stations: ", station)
                    fire = fire.filter((d, i) => i % 10 == 0);
                    og_data = fire
                        // console.log("Fire Dataset: ", fire)
                    var dateSelector = document.getElementById("date_filter")
                    $(function() {
                        $('#daterange').daterangepicker({
                            startDate: "01/01/2014",
                            endDate: "01/01/2020",
                            opens: 'right',
                            linkedCalendars: false,
                            alwaysShowCalendars: false,

                        }, function(start, end, label) {

                            console.log("A new date selection was made: " + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
                            fire = og_data.filter(function(d, i) {
                                date = new Date(d.TFS_Arrival_Time)
                                start = new Date(start)
                                end = new Date(end)
                                    //console.log(start <= date && date <= end)
                                return (start <= date && date <= end);
                            })
                            d3.selectAll("svg").remove();
                            drawMap(toronto, fire, station)
                        });
                    });




                    /*
                    Fire Dataset attributes: 
                    Smoke_Alarm_at_Fire_Orgin_Alaram Failure: Mostly null 
                    Count_of_Persons_Rescued: 0
                    TFS_Arrival_Time: "2015-08-29T11:52:19"
                    Incident_Station_Area: 412
                    Building_Status: null
                    Smoke_Alarm_at_Fire_Origin_Alarm_Type: null
                    Level_Of_Origin: null
                    Latitude: 43.72274
                    Exposures: null
                    Ignition_Source: "81 - Vehicle - Electrical"
                    Property_Use: "850 - Parking Lot Kiosk"
                    Status_of_Fire_On_Arrival: "3 - Fire with smoke showing only - including vehicle, outdoor fires"
                    Civilian_Casualties: 0
                    Sprinkler_System_Presence: null
                    Smoke_Alarm_Impact_on_Persons_Evacuating_Impact_on_Evacuation: null
                    Method_Of_Fire_Control: "1 - Extinguished by fire department"
                    Incident_Ward: 2
                    Business_Impact: null
                    Number_of_responding_apparatus: 1
                    Intersection: "Highway 27 S / Queen's Plate Dr"
                    Fire_Alarm_System_Operation: null
                    Sprinkler_System_Operation: null
                    Fire_Alarm_System_Impact_on_Evacuation: null
                    Fire_Under_Control_Time: "2015-08-29T12:13:53"
                    Estimated_Dollar_Loss: 1000
                    Estimated_Number_Of_Persons_Displaced: null
                    Final_Incident_Type: "01 - Fire"
                    Area_of_Origin: "81 - Engine Area"
                    Longitude: -79.59822
                    TFS_Firefighter_Casualties: 0
                    Smoke_Alarm_at_Fire_Origin: null
                    Material_First_Ignited: "16 - Insulation"
                    Fire_Alarm_System_Presence: null
                    _id: 441424
                    Extent_Of_Fire: null
                    Number_of_responding_personnel: 4
                    Possible_Cause: "51 - Mechanical Failure"
                    Last_TFS_Unit_Clear_Time: "2015-08-29T12:40:36"
                    Initial_CAD_Event_Type: "VEF"
                    Smoke_Spread: null
                    TFS_Alarm_Time: "2015-08-29T11:52:04"
                    Incident_Number: "F15080769"
                    Ext_agent_app_or_defer_time: "2015-08-29T11:52:31"
                    */


                    // Needs an update function for the checkboxes


                    var choices = []
                    d3.selectAll("input[name='cause']").on("change", function() {
                        var choices = [];
                        console.log("Fire incidents check box clicked")
                        d3.selectAll("input[name='cause']:checked").each(function(d) {
                            var cb = d3.select(this);
                            if (cb.property("checked")) {
                                choices.push(cb.property("value"));
                            }
                        });

                        var new_data = fire.filter(function(d, i) {
                            if (choices.length > 0) {
                                my_choices = ""
                                    //console.log("Choices: ", choices)
                                my_choices = choices.join(' ')
                                temp = d.Possible_Cause
                                temp = temp.split("-")
                                temp = temp[1].toString()


                                //console.log(my_choices)
                                //console.log("Sanity check: ", my_choices.includes(temp))
                                return my_choices.includes(temp);
                                choices = []
                            } else return null;
                        })
                        d3.selectAll("svg").remove();
                        drawMap(toronto, new_data, station)


                    });

                    drawMap(toronto, fire, station)

                });
            });

        });


        function drawMap(toronto, fire, station) {



            var mapWidth = 1000,
                mapHeight = 1000;

            var c10 = d3.scale.category10();
            // In newer version
            // d3.scaleOrdinal(d3.schemeCategory10);


            var projection = d3.geo.albers();
            // In newer version
            // var projection = d3.geoAlbers();


            var path = d3.geo.path().projection(projection);
            // In newer version -- NO ERROR BUT NOT WORKING
            //var path = d3.geoPath().projection(projection);

            var svg = d3.select("#vis")
                .append("svg")
                .attr("width", mapWidth)
                .attr("height", mapHeight)
                .call(d3.behavior.zoom().on("zoom", function() {
                    svg.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")")
                }));

            var mapLabel = svg.append("text")
                .attr("y", 20)
                .attr("x", 0)
                .attr("class", "map_neighbourhood_name")


            var neighbourhoods = topojson.feature(toronto, toronto.objects.toronto);

            console.log("Inside draw map with fire data length:", fire.length)

            // set default projection values 
            projection
                .scale(1)
                .translate([0, 0]);

            // creates bounding box and helps with projection and scaling
            var b = path.bounds(neighbourhoods),
                s = .95 / Math.max((b[1][0] - b[0][0]) / mapWidth, (b[1][1] - b[0][1]) / mapHeight),
                t = [(mapWidth - s * (b[1][0] + b[0][0])) / 2, (mapHeight - s * (b[1][1] + b[0][1])) / 2];

            // set project with bounding box data
            projection
                .scale(s)
                .translate(t);

            //Section for color scale:
            var colorScale = d3.scaleThreshold()
                .domain([0, 2, 10, 50, 100, 150, 200, 300])
                .range(d3.schemeReds[9]);

            var list = [];
            // Mushy TODO: Normalize the count of the incidents with area 
            neighbourhoods.features.forEach(function(d) {
                var dict = {}
                var area = d3.geoArea(d) * 10000000

                dict[d] = 0;
                for (var i in fire) {
                    if (d3.geoContains(d, [fire[i].Longitude, fire[i].Latitude])) {
                        dict[d] += 1
                    }
                }
                //console.log("Normalized Score: ", dict[d] / area)
                list.push(dict[d] / area)
            });

            // get individual neighbourhoods
            svg.selectAll("path")
                .data(neighbourhoods.features)
                .enter().append("path")
                .attr("class", "map_neighbourhood")
                .attr("d", path)
                .attr("fill", function(d, i) {
                    //console.log("Data", list[i])
                    //console.log('color: ', colorScale(list[i]))
                    return colorScale(list[i]);
                })
                .on("mouseover", mouseover)
                .on("mouseout", mouseout)
                .on("click", clicked)

            // add the mesh/path between neighbourhoods
            svg.append("path")
                .datum(topojson.mesh(toronto, toronto.objects.toronto, function(a, b) {
                    return a !== b;
                }))
                .attr("class", "map_mesh")
                .attr("d", path);

            // Source: https://bl.ocks.org/tiffylou/88f58da4599c9b95232f5c89a6321992
            var tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Potential source fix: https://jarrettmeyer.com/2018/06/05/svg-multiline-text-with-tspan
            function mouseover(d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", 0.9);
                //Aggregate data here: 

                total_incidents = 0;
                var total_time = 0;
                for (var i in fire) {
                    if (d3.geoContains(d, [fire[i].Longitude, fire[i].Latitude])) {
                        total_incidents += 1
                        arr_t = new Date(fire[i].TFS_Arrival_Time)
                        alarm_t = new Date(fire[i].TFS_Alarm_Time)
                        total_time += (arr_t - alarm_t) / (3600 * 24)

                    }

                }
                var avg_wait_time = total_time / total_incidents

                tooltip.html("Intersection Name: " + d.properties.name.slice(0, -5) +
                        "<br> Total Incidents:" + total_incidents + "<br> Average Waiting Time:" + avg_wait_time.toFixed(2))
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
            }

            /*
                Section to add circles to the Map 
            */



            svg.selectAll('image')
                .data(station)
                .enter()
                .append("image")
                .attr("xlink:href", 'images/fire_extinguisher.png')
                .attr("width", 12)
                // .attr("fill", "red")
                // .attr("r", 5)
                .attr("transform", function(d) {
                    //console.log(projection([d.lon, d.lat]));
                    return `translate(${projection([d.lon, d.lat + 0.005])})`;
                })


            function mouseout(d) {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            }

            function clicked(d) {
                // console.log(d.properties.id, d.properties.name) // verify everything looks good
                // Add code here
            }

            /* LEGEND */
            // TO DO: Needs to fix the range of incident label
            var legendRectSize = 18;
            var legendSpacing = 4;
            var legend = d3.select('#legends')
                .append("svg")
                .attr('width', 100)
                .attr('height', 200);

            legend.selectAll("g")
                .data(colorScale.domain())
                .enter()
                .append('g')
                .attr('class', 'legend')
                .attr('transform', function(d, i) {
                    var height = legendRectSize + legendSpacing;
                    var offset = height * colorScale.domain().length / 2;
                    var horz = -2 * legendRectSize + 40;
                    var vert = i * height - offset + 100;
                    return 'translate(' + horz + ',' + vert + ')';
                });

            legend.selectAll("g")
                .append('rect')
                .attr('width', legendRectSize)
                .attr('height', legendRectSize)
                .style('fill', colorScale)
                .style('stroke', colorScale);

            legend.selectAll("text")
                .data(colorScale.domain())
                .enter()
                .append('text')
                .attr('x', 30)
                .attr("font-size", "10px")
                .attr('y', function(d, i) {
                    return (i + 1) * 22;
                })
                .style('fill', 'white')
                .text(function(d) {
                    console.log(d)
                    return d;
                });

            /* This needs newer version of the libraries)*/
            var y = d3.scaleLinear()
                .range([300, 0])
                .domain([68, 12]);


            var yAxis = d3.axisBottom()
                .scale(y)
                .ticks(5);


            console.log("Finisshed Drawing map")

            key.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(0,30)")
                .call(yAxis)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text("axis title");

        }
    </script>
</body>

</html>